#!/bin/bash

set -e
#set -x

function mountDevice {
	mkdir -p /mnt/$1
	if [[ $(mount | grep /mnt/$1) ]]; then
		echo "$1 already mounted"
	else
		mount /dev/$1 /mnt/$1
		echo "$1 was mounted"
	fi;
}

function umountDevice {
	if [[ $(mount | grep /mnt/$1) ]]; then
		umount /mnt/$1
		rmdir /mnt/$1
		echo "$1 was umounted"
	else
		echo "$1 is not mounted"
	fi;
}

function syncFromTo {
	umountDevice $1
	umountDevice $2
	mountDevice $1
	mountDevice $2
	# TODO: maybe mount source device as read only

	echo "start sync $1 to $2"
	rsync -axHAWXS --numeric-ids --info=progress2 \
	--delete --delete-excluded --exclude='/.gvfs/' --exclude="/mnt/" \
	/mnt/$1/ /mnt/$2/
	echo "done sync $1 to $2"

	umountDevice $1
	umountDevice $2
}

# backup system primary
#syncFromTo sda1 sdb1
#syncFromTo sda5 sdb5

# backup system secondary
#syncFromTo sdb1 sdc1
#syncFromTo sdb5 sdc2

# TODO: option to sync without delete, needed for storage
# TODO: option to define pipelines, eg: sdb5-sdc2,delete; sda4-sdb4,keep
# TODO: option to choose target at runtime: primary system, secondary system, primary storage, secondary storage

